name: Update Gist Visit Counter

on:
  # å½“æœ‰äººè®¿é—®ç½‘ç«™æ—¶è§¦å‘ï¼ˆé€šè¿‡APIè°ƒç”¨ï¼‰
  repository_dispatch:
    types: [visit_count, update_visitor_count]
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'increment'
        type: choice
        options:
        - increment
        - reset

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update Gist
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        GH_ACTION_TRIGGER_TOKEN: ${{ secrets.GH_ACTION_TRIGGER_TOKEN }}
        GIST_ID: f43cb9d745fd37f6403fdc480ffcdff8
      run: |
        # è·å–ä»Šå¤©çš„æ—¥æœŸ
        TODAY=$(date -u +"%Y-%m-%d")
        
        echo "ğŸš€ GitHub Actionè§¦å‘ - äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "ğŸ“… ä»Šå¤©æ—¥æœŸ: $TODAY"
        
        # ä¸‹è½½å½“å‰Gistå†…å®¹
        echo "ğŸ“¥ è·å–å½“å‰Gistæ•°æ®..."
        curl -H "Authorization: token $GIST_TOKEN" \
             -H "Accept: application/vnd.github.v3+json" \
             "https://api.github.com/gists/$GIST_ID" > gist_response.json
        
        # æ£€æŸ¥APIå“åº”
        if [ $? -ne 0 ]; then
          echo "âŒ æ— æ³•è·å–Gistæ•°æ®"
          exit 1
        fi
        
        # æå–æ–‡ä»¶å†…å®¹
        CURRENT_DATA=$(cat gist_response.json | jq -r '.files["gistfile1.txt"].content')
        echo "ğŸ“Š å½“å‰æ•°æ®: $CURRENT_DATA"
        
        # è§£æJSONæ•°æ®
        if [ "${{ github.event.event_type }}" = "update_visitor_count" ]; then
          # ä»client_payloadè·å–æ•°æ® (PATè§¦å‘æ–¹å¼)
          TOTAL_VISITS="${{ github.event.client_payload.total_visits }}"
          TODAY_VISITS="${{ github.event.client_payload.today_visits }}"
          LAST_UPDATED="${{ github.event.client_payload.last_updated }}"
          
          echo "ğŸ“¥ ä»PATè§¦å‘è·å–æ•°æ®:"
          echo "  æ€»è®¿é—®é‡: $TOTAL_VISITS"
          echo "  ä»Šæ—¥è®¿é—®: $TODAY_VISITS"  
          echo "  æœ€åæ›´æ–°: $LAST_UPDATED"
          echo "  è§¦å‘æ—¶é—´: ${{ github.event.client_payload.trigger_time }}"
          echo "  ç”¨æˆ·ä»£ç†: ${{ github.event.client_payload.user_agent }}"
          
          # ç›´æ¥ä½¿ç”¨payloadæ•°æ®
          NEW_TOTAL_VISITS="$TOTAL_VISITS"
          NEW_TODAY_VISITS="$TODAY_VISITS"
          TODAY="$LAST_UPDATED"
        else
          # ä¼ ç»Ÿå¢é‡æ›´æ–°æ–¹å¼
          TOTAL_VISITS=$(echo "$CURRENT_DATA" | jq -r '.total_visits // 0')
          TODAY_VISITS=$(echo "$CURRENT_DATA" | jq -r '.today_visits // 0')
          LAST_UPDATED=$(echo "$CURRENT_DATA" | jq -r '.last_updated // ""')
          
          echo "ğŸ“ˆ ä¼ ç»Ÿæ¨¡å¼æ•°æ®:"
          echo "  æ€»è®¿é—®é‡: $TOTAL_VISITS"
          echo "  ä»Šæ—¥è®¿é—®: $TODAY_VISITS"
          echo "  æœ€åæ›´æ–°: $LAST_UPDATED"
          
          # åˆ¤æ–­æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©
          if [ "$LAST_UPDATED" != "$TODAY" ]; then
            echo "ğŸŒ… æ–°çš„ä¸€å¤©ï¼Œé‡ç½®ä»Šæ—¥è®¿é—®é‡"
            NEW_TODAY_VISITS=1
          else
            echo "ğŸ“ˆ åŒä¸€å¤©ï¼Œå¢åŠ ä»Šæ—¥è®¿é—®é‡"
            NEW_TODAY_VISITS=$((TODAY_VISITS + 1))
          fi
          
          # å¢åŠ æ€»è®¿é—®é‡
          NEW_TOTAL_VISITS=$((TOTAL_VISITS + 1))
        fi
        
        # æ„å»ºæ–°çš„JSONæ•°æ®
        NEW_DATA=$(jq -n \
          --argjson total "$NEW_TOTAL_VISITS" \
          --argjson today "$NEW_TODAY_VISITS" \
          --arg date "$TODAY" \
          '{
            "total_visits": $total,
            "today_visits": $today,
            "last_updated": $date,
            "daily_stats": {}
          }')
        
        echo "ğŸ”„ æ›´æ–°åçš„æ•°æ®: $NEW_DATA"
        
        # æ›´æ–°Gist
        echo "ğŸ“¤ ä¸Šä¼ æ›´æ–°åˆ°Gist..."
        curl -X PATCH \
             -H "Authorization: token $GIST_TOKEN" \
             -H "Accept: application/vnd.github.v3+json" \
             -H "Content-Type: application/json" \
             "https://api.github.com/gists/$GIST_ID" \
             -d "{
               \"files\": {
                 \"gistfile1.txt\": {
                   \"content\": $(echo "$NEW_DATA" | jq -c .)
                 }
               }
             }"
        
        echo "âœ… Gistæ›´æ–°å®Œæˆï¼"
        echo "æ–°çš„æ€»è®¿é—®é‡: $NEW_TOTAL_VISITS"
        echo "æ–°çš„ä»Šæ—¥è®¿é—®é‡: $NEW_TODAY_VISITS"
